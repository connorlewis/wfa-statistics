---
title: "WFA Statistics"
output:
  flexdashboard::flex_dashboard:
    theme: cosmo
    vertical_layout: scroll
runtime: shiny
---


```{r setup, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(flexdashboard)
library(knitr)
library(shiny)
library(tidyverse)
library(DT)
library(rsconnect)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.align = 'center', fig.dim = c(4, 6) )


# set the theme for all ggplots: 
theme_set(theme_minimal() +
            theme(plot.title = element_text(hjust = 0.5)
                  , axis.text = element_text(size = 10)
                  , axis.title=element_text(size=14,face="bold")))

source("data_prep.R")
#pass.sum.dta <- read_csv("PassingDataTemp.csv")
#rsconnect::setAccountInfo(name='connorjo',
#			  token='966F109BEA1433280CB80AACEF59B28F',
#			  secret='7l/D0vouhjiFkeEZwmyB0anPqXFAXJogfqqifjN7')
#rsconnect::deployApp('wfa_dash.Rmd')
```



<!-- Sidebar {.sidebar} -->
<!-- ===================================== -->


<!-- logo: www/tractor_resized.png -->
<!-- favicon: www/tractor_resized.png -->
<!-- social: menu -->
<!-- css: styles.css -->


About {data-navmenu="Home"}
=====================================

We are currently only looking at the 2018 season (end of season). 

_Pages that are somewhat complete:_

* Offense -> Quarterbacks

League Overview {data-navmenu="Home"}
=====================================

Top Performers {data-navmenu="Home"}
=====================================


<!-- OFFENSE -->

Overall {data-navmenu="Offense"}
=====================================


Inputs {.sidebar data-width=250}
----------------------------------------------------------------------


Quarterbacks {data-navmenu="Offense" data-orientation=rows}
=====================================


Inputs {.sidebar data-width=250}
-----------------------------------------------------------------------


```{r passing.input}
# What players (QBs) will be compared/analyzed
selectInput("player", "QB (>50 attempts)", choices = c('', unique(pass.sum.dta$Player))
              , selected = NULL, multiple = FALSE, selectize = TRUE)

checkboxInput("comp", "Compare to another QB", value = FALSE)

# Player rankings on side: 


conditionalPanel(
      condition = "input.comp",
      selectInput("comp.plyr", ""
            , choices =  c('', unique(pass.sum.dta$Player))
            , selected = NULL, multiple = FALSE
            , selectize = TRUE))



# All weeks for the players selected
temp.dta <- reactive({
    dta <- pass.sum.dta %>% 
                filter(Player %in% c(input$player, input$comp.plyr)) %>%
                ungroup
    
    dta
  })

# Only the last week played of data for the players selected
temp.last.dta <- reactive({
  temp.dta() %>%
      group_by(Player) %>%
      top_n(1, as.numeric(game)) %>%
      ungroup
})

# A table of the rating of the QB, by passer rating (last weeks data)
temp.comp.dta <- reactive({
  temp.df <- temp.last.dta() %>%
                select(plyr.lbl, Games = game, Attempts = Att.cum
                  , `Comp (%)` = comp.rate, TD = TD.cum
                  , `Avg Yds` = avg.cum) %>% 
      t
            
      plyr.names <- temp.df[1, ]
      
      temp.df <- temp.df %>%
        data.frame()
      
      names(temp.df) <- plyr.names
      
      temp.df %>%
        rownames_to_column("Stat") %>%
        filter(Stat != "plyr.lbl") 
})

renderTable(
  if(input$player != '' | input$comp.plyr != '') {temp.comp.dta()}
)


```


Row {data-height=100}
-----------------------------------------------------------------------

### Team {.value-box}
```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  value <- temp.last.dta() %>% 
             filter(Player == input$player) %>%
             select(team)
  valueBox(value
           , icon = "fa-football-ball")
})

```

### Total Passing Yards {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  value <- temp.last.dta() %>% 
             filter(Player == input$player) %>%
             select(Yds.cum)
  valueBox(value
           , icon = "fa-football-ball")
})

```


### Total Touchdowns {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  valueBox(temp.last.dta() %>% 
             filter(Player == input$player) %>%
             select(TD.cum)
           , icon = "fa-football-ball")
})
```

### Player Ranking {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  valueBox("TBD"
           , icon = "fa-trophy")
})
```


Row {data-height=350}
-----------------------------------------------------------------------

### Total passing yards vs. passing attempts


```{r passyrds.plot}
renderPlot({

  temp.last.dta() %>%
    ggplot(aes(x = Att.cum, y = Yds.cum
               , label = plyr.lbl)) +
    
    # plots all of the players in grey with a red line for the lm
    geom_point(data = pass.sum.dta %>%
                group_by(Player) %>%
                filter(Player != input$player) %>%
                top_n(1, week)
                , mapping = aes(x = Att.cum, y = Yds.cum)
                , color = "grey") +
    geom_smooth(data = pass.sum.dta %>%
                group_by(Player) %>%
                top_n(1, week)
                , mapping = aes(x = Att.cum, y = Yds.cum)
                , method = "lm", se = FALSE, color = "red") +
    
    # plot the selected players
    geom_point(size = 3, color = "blue") +
    geom_text(nudge_y = 100, color = "blue") +
    labs(x = "Total Attempts", y = "Total Yards"
         , caption = "Grey dots represent all non-selected QBs") +
    coord_cartesian(xlim = c(50, pass.att.max)
                    , ylim = c(pass.yrd.min, pass.yrd.max)) +
    scale_color_discrete(guide = FALSE) 
})
```


### Touchdown Rate/Interception Rate

```{r td.int.plot}
renderPlot({

   temp.dta() %>%
    ggplot(aes(x = game, y = TD.Int.cum
               , group = Player)) +
    
       geom_line(data = pass.sum.dta 
            , mapping = aes(x = game, y = TD.Int.cum
                            , group = factor(Player))
            , color = "grey") +
       geom_smooth(data = pass.sum.dta 
                , mapping = aes(x = game, y = TD.Int.cum)
                , method = "loess", se = FALSE, color = "red") +
   
    geom_point(size = 3, color = "blue") +
    geom_line(color = "blue") +
    # geom_text(nudge_x = 5) +
    labs(x = "Game"
         , y = "Ratio"
         , caption = "Grey lines represent all non-selected QBs") +
    coord_cartesian(xlim = c(0, 8)
                    , ylim = c(0, 15)) +
    scale_color_discrete(guide = FALSE) +
    geom_text(data = temp.last.dta(),
              mapping = aes(x = game - 0.8, y = TD.Int.cum, label = plyr.lbl)
              ,  color = "blue" )

})
```


Running Backs {data-navmenu="Offense" data-orientation=rows}
=====================================


Inputs {.sidebar data-width=250}
-----------------------------------------------------------------------


```{r rushing.input}
# What players (QBs) will be compared/analyzed
selectInput("rb", "RB (>50 attempts)", choices = c('', unique(rush.sum.dta$Player))
              , selected = NULL, multiple = FALSE, selectize = TRUE)

checkboxInput("comprb", "Compare to another RB", value = FALSE)

# Player rankings on side: 


conditionalPanel(
      condition = "input.comprb",
      selectInput("comp.rb", ""
            , choices =  c('', unique(rush.sum.dta$Player))
            , selected = NULL, multiple = FALSE
            , selectize = TRUE))



# All weeks for the players selected
temp.rb.dta <- reactive({
    dta <- rush.sum.dta %>% 
                filter(Player %in% c(input$rb, input$comp.rb)) %>%
      ungroup
    
    dta
  })

# Only the last week played of data for the players selected
temp.rb.last.dta <- reactive({
  temp.rb.dta() %>%
      group_by(Player) %>%
      top_n(1, as.numeric(game)) %>%
      ungroup
})

# A table of the rating of the QB, by passer rating (last weeks data)
temp.rb.comp.dta <- reactive({
  temp.df <- temp.rb.last.dta() %>%
                select(plyr.lbl, Games = game, Carries = car.cum
                  , TD = TD.cum, `Avg Yds` = avg.cum, `Yds per Game` = yds.cum.game) %>% 
      t
            
      plyr.names <- temp.df[1, ]
      
      temp.df <- temp.df %>%
        data.frame()
      
      names(temp.df) <- plyr.names
      
      temp.df %>%
        rownames_to_column("Stat") %>%
        filter(Stat != "plyr.lbl") 
})

renderTable(
  if(input$rb != '' | input$comp.rb != '') {temp.rb.comp.dta()}
)


```


Row {data-height=100}
-----------------------------------------------------------------------

### Team {.value-box}
```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  value <- temp.rb.last.dta() %>% 
             filter(Player == input$rb) %>%
             select(team)
  valueBox(value
           , icon = "fa-football-ball")
})

```

### Total Yards {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  value <- temp.rb.last.dta() %>% 
             filter(Player == input$rb) %>%
             select(yds.cum)
  valueBox(value
           , icon = "fa-football-ball")
})

```


### Touchdowns {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  valueBox(temp.rb.last.dta() %>% 
             filter(Player == input$rb) %>%
             select(TD.cum)
           , icon = "fa-football-ball")
})
```

### Player Ranking {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  valueBox("TBD"
           , icon = "fa-trophy")
})
```


Row {data-height=350}
-------------------------------------------------------------


### Rushing Yards by Game

```{r rush.yrds.game}
renderPlot({
   temp.rb.dta() %>%
    ggplot(aes(x = game, y = as.numeric(Yards)
               , group = Player)) +
    
       geom_line(data = rush.sum.dta 
            , mapping = aes(x = game, y = as.numeric(Yards)
                            , group = factor(Player))
            , color = "grey") +
    
    geom_point(size = 3, color = "blue") +
    geom_line(color = "blue") +
    # geom_text(nudge_x = 5) +
    labs(x = "Game"
         , y = "Yards"
         , caption = "Grey lines represent non-selected runningbacks.") +
    coord_cartesian(xlim = c(1, 8)
                    , ylim = c(0, 300)) +
    scale_color_discrete(guide = FALSE) +
    geom_text(data = temp.rb.last.dta(),
              mapping = aes(x = game - 0.8, y = as.numeric(Yards)
                            , label = plyr.lbl)
              , color = "blue" ) 

})
```

### Rushing Yards per Carry by Game
```{r rush.yrds.car}
renderPlot({
   temp.rb.dta() %>%
    ggplot(aes(x = game, y = yds.game
               , group = Player)) +
    
       geom_line(data = rush.sum.dta 
            , mapping = aes(x = game, y = yds.game
                            , group = factor(Player))
            , color = "grey") +
    
    geom_point(size = 3, color = "blue") +
    geom_line(color = "blue") +
    # geom_text(nudge_x = 5) +
    labs(x = "Game"
         , y = "Yards per Carry"
         , caption = "Grey lines represent non-selected runningbacks.") +
    coord_cartesian(xlim = c(1, 8)
                    , ylim = c(0, 40)) +
    scale_color_discrete(guide = FALSE) +
    geom_text(data = temp.rb.last.dta(),
              mapping = aes(x = game - 0.8, y = yds.game
                            , label = plyr.lbl)
              , color = "blue" ) 

})
```


Wide Receivers {data-navmenu="Offense" data-orientation=rows}
=====================================




Inputs {.sidebar data-width=250}
-----------------------------------------------------------------------


```{r receiving.input}
# What players (QBs) will be compared/analyzed
 selectInput("wr", "wr (>10 attempts)", choices = c('', unique(rec.sum.dta$Player))
              , selected = NULL, multiple = FALSE, selectize = TRUE)

checkboxInput("compwr", "Compare to another Receiver", value = FALSE)

# Player rankings on side: 


conditionalPanel(
      condition = "input.compwr",
      selectInput("comp.wr", ""
            , choices =  c('', unique(rec.sum.dta$Player))
            , selected = NULL, multiple = FALSE
            , selectize = TRUE))



# All weeks for the players selected
temp.wr.dta <- reactive({
    dta <- rec.sum.dta %>% 
                filter(Player %in% c(input$wr, input$comp.wr)) %>%
      ungroup
    dta
  })

# Only the last week played of data for the players selected
temp.wr.last.dta <- reactive({
  temp.wr.dta() %>%
      group_by(Player) %>%
      top_n(1, as.numeric(game)) %>%
      ungroup
})

# A table of the rating of the QB, by passer rating (last weeks data)
temp.wr.comp.dta <- reactive({
  temp.df <- temp.wr.last.dta() %>%
                select(plyr.lbl, Games = game, Receptions = rec.cum
                  , TD = TD.cum, `Avg Yds` = avg.cum, `Yds per Game` = yds.cum.game) %>% 
      t
            
      plyr.names <- temp.df[1, ]
      
      temp.df <- temp.df %>%
        data.frame()
      
      names(temp.df) <- plyr.names
      
      temp.df %>%
        rownames_to_column("Stat") %>%
        filter(Stat != "plyr.lbl") 
})

renderTable(
  if(input$wr != '' | input$comp.wr != '') {temp.wr.comp.dta()}
)


```


Row {data-height=100}
-----------------------------------------------------------------------

### Team {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  value <- temp.wr.last.dta() %>% 
             filter(Player == input$wr) %>%
             select(team)
  valueBox(value
           , icon = "fa-football-ball")
})

```

### Total Yards {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  value <- temp.wr.last.dta() %>% 
             filter(Player == input$wr) %>%
             select(yds.cum)
  valueBox(value
           , icon = "fa-football-ball")
})

```


### Touchdowns {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  valueBox(temp.wr.last.dta() %>% 
             filter(Player == input$wr) %>%
             select(TD.cum)
           , icon = "fa-football-ball")
})
```

### Player Ranking {.value-box}

```{r}
# A box showing the total cumulative yards for the selected player
renderValueBox({
  valueBox("TBD"
           , icon = "fa-trophy")
})
```



Complete Stats {data-navmenu="Offense"}
=====================================

Row
----------------------------------------------------------------------

### Passing 

```{r}
datatable(pass.sum.dta %>% 
  group_by(Player) %>%
          top_n(1, as.numeric(game)) %>%
          select(Player, Games = game, Rating, Attempts = Att.cum
                 , Comp = comp.cum, Yds = Yds.cum, Avg = avg.cum
                 , TD = TD.cum) %>%
          arrange(desc(as.numeric(Rating)))
  , options = list(bPaginate = FALSE, pageLength = 10), fillContainer = TRUE)
          
```


### Rushing

```{r}

```


### Receiving

<!--  DEFENSE -->

League {data-navmenu="Defense"}
=====================================

By Division {data-navmenu="Defense"}
=====================================

By Team {data-navmenu="Defense"}
=====================================

By Position {data-navmenu="Defense"}
=====================================

By Player {data-navmenu="Defense"}
=====================================


League {data-navmenu="Special Teams"}
=====================================

By Division {data-navmenu="Special Teams"}
=====================================

By Team {data-navmenu="Special Teams"}
=====================================


Prediction {data-navmenu="Analytics"}
=====================================

Team Rankings {data-navmenu="Analytics"}
=====================================

Player Rankings {data-navmenu="Analytics"}
=====================================

